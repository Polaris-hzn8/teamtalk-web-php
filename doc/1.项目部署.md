# 项目部署

---

### 实体机部署

#### 安装nginx

1. 编译安装Nginx源码：

   ```shell
   # 安装必要的第三方依赖包
   sudo apt-get -y install libpcre3 libpcre3-dev
   sudo apt-get -y install zlib1g-dev
   sudo apt-get install openssl libssl-dev
   # 下载稳定的Nginx版本
   wget http://nginx.org/download/nginx-1.16.1.tar.gz
   # 解压编译安装
   # 安装后的执行文件路径：/usr/local/nginx/sbin/
   # 配置文件路径：/usr/local/nginx/conf/
   tar -zxvf nginx-1.16.1.tar.gz
   cd nginx-1.16.1
   ./configure --prefix=/usr/local/nginx
   make
   sudo make install
   # 创建配置文件子目录 并在nginx.conf文件中包含conf.d
   # 在末尾添加 include /usr/local/nginx/conf/conf.d/*.conf;
   # 目的是在部署即时通讯的web管理后台时将对应的.conf文件拷贝到 /usr/local/nginx/conf/conf.d 目录时就能够被 nginx.conf 包含
   sudo mkdir /usr/local/nginx/conf/conf.d
   sudo mkdir -p /usr/local/nginx/conf/conf.d/
   sudo vim /usr/local/nginx/conf/nginx.conf
   # 将默认的80端口修改为81 因为web管理后台需要占用80端口
   server {
   	listen 81;
   	server_name localhost;
   	wcharset koi8-r;
   }
   ```

2. 配置启动Nginx

   ```shell
   # 创建一个nginx.service
   # 在 /lib/systemd/system/目录下面新建一个nginx.service文件，并赋予可执行的权限
   sudo vim /lib/systemd/system/nginx.service
   # 编辑service内容
   [Unit]
   Description=nginx - high performance web server
   After=network.target remote-fs.target nss-lookup.target
   [Install]
   WantedBy=multi-user.target
   [Service]
   Type=forking
   ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf
   ExecReload=/usr/local/nginx/sbin/nginx -s reload
   ExecStop=/usr/local/nginx/sbin/nginx -s stop
   # 启动服务
   # 在启动服务之前，需要先重载systemctl命令
   sudo systemctl daemon-reload
   sudo systemctl start nginx.service # 启动nginx
   ```

3. 启动/停止/重启Nginx服务

   ```shell
   sudo systemctl start nginx.service	# 启动
   sudo systemctl stop nginx.service	# 停止
   sudo systemctl reload nginx.service 	# 重新加载
   systemctl status nginx.service			# 显示nginx服务的状态
   sudo systemctl enable nginx.service		# 在开机时启用nginx服务
   sudo systemctl disable nginx.service	# 在开机时禁用nginx服务
   ```

4. 查看Nginx运行情况：

   ```shell
   sudo ps -ef | grep nginx
   sudo netstat -tap | grep nginx
   sudo lsof -i:81	# 查看81端口监听情况
   ```

   ![image-20250215013158233](assets\image-20250215013158233.png)

#### 项目打包部署

在项目src\tools目录下包含：config.php，database.php，im.com.conf三个配置文件：

1. config.php：配置了msfs图片服务器的地址，修改 `$config['msfs_url']` 至对应的ip地址即可，
2. dababase.php：配置了连接mysql数据库所需参数，根据自己的需求修改`hostname`、`username`、`password` 这三个参数即可
3. im.com.conf：Nignx配置文件不建议改动，包含了php的配置以及php所需的nginx相关配置

如果使用的是现有的nginx + php环境：

1. 可以修改setup.sh中的 `PHP_WEB_SETUP_PATH` 为nginx放置 web代码的路径
2. 并且将 `PHP_NGINX_CONF_PATH` 修改为nginx配置文件的路径
3. 然后执行setup.sh脚本即可

```nginx
# im.com.conf
# 配置nginx如何处理http请求、php文件以及静态资源
server
{
    # 基本信息
    listen       80;																# 监听 80 端口
    server_name  0.0.0.0;															# 绑定所有 IP（0.0.0.0）
    index index.html index.htm index.php default.html default.htm default.php;		# 默认首页文件
    root         /var/www/html/im-server-web;										# 网站根目录
	
    # PHP 文件处理

    # Nginx + PHP-FPM 配合处理 PHP 请求的核心配置
    # 匹配以 .php 结尾的请求
    location ~ \.php($|/) {
        fastcgi_pass   unix:/run/php/php7.2-fpm.sock;							# 将请求转发给 PHP-FPM 解析（这里用的是 Unix Socket）
        fastcgi_index  index.php;
        fastcgi_split_path_info ^(.+\.php)(.*)$;								# 支持 /index.php/xxx 这种路径形式
        fastcgi_param   PATH_INFO $fastcgi_path_info;
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;		# 指定 PHP 脚本的绝对路径
        include        fastcgi_params;											# 引入标准 FastCGI 参数
    }
	
    # 静态资源缓存
    # 对图片/Flash 文件缓存 30 天
    location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$
    {
            expires      30d;
    }
	
    # 对 JS/CSS 文件缓存 12 小时
    location ~ .*\.(js|css)?$
    {
            expires      12h;
    }
    # URL重写
    if (!-e $request_filename) {
        rewrite ^/(.*)$ /index.php/$1 last;
        break;
    }
}
```



### 容器化部署

项目场景为Nginx+php的方案（传统的LEMP架构），这与单纯的使用nginx提供静态文件或反向代理不太一样，php需要php-fpm来解析执行php脚本。

1. 方案1：nginx官方镜像 + 独立的php-fpm容器（推荐生成环境）方案思路：
   - Nginx 容器负责处理 HTTP 请求
   - PHP-FPM 容器负责解析 PHP
   - Nginx 通过 `fastcgi_pass` 转发请求给 PHP-FPM 
   - 优点：Nginx 和 PHP-FPM 独立容器化管理清晰、可以单独扩展 Nginx 或 PHP-FPM 容器、容器镜像小更新方便
2. 方案2：自建nginx + php-fpm镜像，
   - 将Nginx 和 PHP-FPM 放在同一个容器中
   - 缺点：如果 PHP-FPM 或 Nginx 崩溃需要重启整个容器









